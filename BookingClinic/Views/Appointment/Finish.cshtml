@using BookingClinic.Services.Data.Appointment
@model AppointmentDoctorDataDto
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    ViewData["Error"] = "New appointment";
    var patientId = Model.PatientId;
}

<form id="appointmentForm" method="post" asp-controller="Doctor" asp-action="MakeAppointmentDoctor" class="d-none">
    <input type="hidden" name="patientId" id="patientIdInput" />
    <input type="hidden" name="appointmentDay" id="appointmentDayInput" />
    <input type="hidden" name="appointmentTime" id="appointmentTimeInput" />
</form>

<!-- Confirm appointment modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">Confirm appointment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmModalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmModalOk">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<div class="container mt-4">
    <h2 class="text-center mb-4">Create a New Appointment</h2>
    <p class="text-center text-muted mb-4">Choose a suitable time for appointment:</p>

    <div class="d-flex overflow-auto pb-3">
        @foreach (var day in Model.Appointments)
        {
            <div class="card shadow-sm me-3 flex-shrink-0" style="min-width: 250px; max-width: 300px;">
                <div class="card-header bg-primary text-white text-center fw-semibold">
                    @day.Item1
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap justify-content-center gap-2" style="width: 100%;">
                        @foreach (var time in day.Item2)
                        {
                            <button type="button"
                                    class="btn btn-outline-primary btn-sm px-3 py-2"
                                    onclick="confirmAppointment('@day.Item1', '@time', '@patientId')">
                                @time
                            </button>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
    <div class="text-center mt-4">
        <a asp-controller="Appointment" asp-action="Index" class="btn btn-secondary px-4">
            Return to appointments
        </a>
    </div>
</div>

<!-- Appointment modal script -->
<script>
    let appointmentData = {};

    function confirmAppointment(day, time, patientId) {
        appointmentData = { day, time, patientId };
        document.getElementById('confirmModalBody').innerText =
            `Are you sure you want to assign an appointment on ${day} at ${time}?`;
        let modal = new bootstrap.Modal(document.getElementById('confirmModal'));
        modal.show();
    }

    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('confirmModalOk').addEventListener('click', function () {
            document.getElementById('patientIdInput').value = appointmentData.patientId;
            document.getElementById('appointmentDayInput').value = appointmentData.day;
            document.getElementById('appointmentTimeInput').value = appointmentData.time;
            document.getElementById('appointmentForm').submit();
        });
    });
</script>